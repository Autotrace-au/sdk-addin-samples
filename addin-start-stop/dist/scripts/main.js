"use strict";geotab.addin.startStop=function(){function e(e,t,n){return new Promise(function(a,i){s.call("Get",{typeName:"Trip",search:{deviceSearch:{id:e},fromDate:t,toDate:n}},a,i)})}function t(e,t,n,a){var i=t/1e3/60,o=i*n;a=a||"",m=document.getElementById("stopStart-times"+a),g=document.getElementById("stopStart-idling"+a),v=document.getElementById("stopStart-fuel"+a),e===-1?(m.innerText="-",g.innerText="-:--",v.innerText="-"):(m.innerText=Math.round(e),g.innerText=u(t/1e3),v.innerText=Math.round(o*h*100)/100)}function n(e,n,a){t(e,n,a,"-annual")}function a(){t(-1),n(-1),""!==this.value&&d(this.value)}function i(){var e=document.getElementById("stopStart-vehicleSelect");e.innerHTML="",e.removeEventListener("change",a),e.appendChild(function(){var e=document.createElement("option");return e["default"]=!0,e.selected=!0,e.value="",e.textContent=f.translate("Select a vehicle..."),e}()),y(function(t){t.forEach(function(t){var n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}),e.addEventListener("change",a)})}function o(e){s.getSession(function(t){var n=t.userName;s.call("Get",{typeName:"User",search:{name:n}},function(t){if(0===t.length)throw new Error("Unable to find currently logged on user.");var n=t[0];switch(n.fuelEconomyUnit){case"LitersPer100Km":h=1,p=f.translate("Liters");break;case"KmPerLiter":h=1,p=f.translate("Liters");break;case"MPGUS":h=1/E,p=f.translate("Gallons (US)");break;case"MPGImperial":h=1/I,p=f.translate("Gallons (UK)");break;default:h=1,p=f.translate("Liters")}console.log(n.isMetric),console.log(n.fuelEconomyUnit),console.log(n.language),console.log(n.dateFormat),console.log(n.timeZoneId),e()},function(e){throw"Error while trying to load currently logged on user. "+e})})}function r(){document.getElementById("stopStart-volume-label").innerHTML=p,document.getElementById("stopStart-volume-label-annual").innerHTML=p}function c(e,t,n){return new Promise(function(a,i){s.multiCall([["Get",{typeName:"StatusData",search:{deviceSearch:{id:e},fromDate:t.toISOString(),toDate:n.toISOString()}}],["Get",{typeName:"LogRecord",search:{deviceSearch:{id:e},fromDate:t,toDate:n}}]],function(e){var t=e[0],n=e[1],i=!1,o=!1,r=!1,c=null,l=null,u=null,d=0,s=0,f=0,m=void 0,g=void 0,v=void 0,h=[],p=t.filter(function(e){switch(e.diagnostic.id){case"DiagnosticVehicleActiveId":case"DiagnosticEngineSpeedId":case"DiagnosticTotalTripIdleFuelUsedId":return!0;default:return!1}});for(p=p.concat(n),p=p.map(function(e){return e.dateTime=new Date(e.dateTime),e}),p.sort(function(e,t){return e.dateTime-t.dateTime}),g=0;g<p.length;g++){if(m=p[g],m.diagnostic)switch(m.diagnostic.id){case"DiagnosticVehicleActiveId":i=1===m.data;break;case"DiagnosticEngineSpeedId":o=m.data>0;break;case"DiagnosticTotalTripIdleFuelUsedId":s+=m.data}else r=0!==m.speed;if(!r&&o&&null==u&&(u=m.dateTime),null===u||!r&&o||(d+=m.dateTime-u,u=null),!i||o||v){if(v&&(!i||o)){l=m.dateTime;var D=l-c;D>S&&h.push({fromDate:c,duration:l-c}),v=!1}}else v=!0,c=m.dateTime}f=d>0&&s>T?s/(d/1e3/60):0,a({fuelUsedPerMinuteIdling:f,stopStarts:h})},i)})}function l(e,t,n){var a=0,i=!1,o={next:function(){i||(a<e?(a++,t(o)):(i=!0,n()))},iteration:function(){return a-1},"break":function(){i=!0,n()}};return o.next(),o}function u(e){var t=parseInt(e,10),n=Math.floor(t/3600),a=Math.floor((t-3600*n)/60);return a<10&&(a="0"+a),n+":"+a}function d(a){document.getElementById("stopStart-vehicleSelect").disabled=!0;var i=new Date,o=new Date;o.setDate(i.getDate()-1);var r=0,u=0,d=0;l(30,function(e){c(a,o,i).then(function(n){var a=n.stopStarts,c=n.fuelUsedPerMinuteIdling;u+=a.length,u>0&&(a.forEach(function(e){r+=e.duration}),c>0&&(d=0===d?c:(d+c)/2),t(u,r,d)),o.setDate(o.getDate()-1),i.setDate(i.getDate()-1),e.next()})},function(){o=new Date,i=new Date,o.setDate(o.getDate()-30),e(a,o,i).then(function(t){var c=0,s=void 0,f=void 0;t.forEach(function(e){c+=e.distance}),c>0?(s=u/c,f=r/c,n(s*c,f*c,d),l(11,function(t){e(a,o,i).then(function(e){e.forEach(function(e){c+=e.distance}),n(s*c,f*c,d),o.setDate(o.getDate()-30),i.setDate(i.getDate()-30),t.next()})},function(){document.getElementById("stopStart-vehicleSelect").disabled=!1})):document.getElementById("stopStart-vehicleSelect").disabled=!1})})}var s=void 0,f=void 0,m=void 0,g=void 0,v=void 0,h=void 0,p=void 0,D=void 0,S=2e3,I=4.54609,E=3.785411784,T=.1,y=function(){var e=void 0;return function(t){e=t,s.call("Get",{typeName:"Device",search:{groups:f.getGroupFilter(),fromDate:(new Date).toISOString()}},function(n){var a=n.sort(function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())}).map(function(e){return{name:e.name,id:e.id}});e===t&&e(a)},function(e){alert(e)})}}();return{initialize:function(e,t,n){s=e,f=t,D=document.getElementById("startStop"),f.translate&&f.translate(D||""),n()},focus:function(e,n){s=e,f=n,t(-1),i(o(r)),D.className=""},blur:function(){D.className="hidden"}}};