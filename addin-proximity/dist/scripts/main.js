"use strict";function asyncGeneratorStep(e,t,n,a,i,r,o){try{var c=e[r](o),d=c.value}catch(e){return void n(e)}c.done?t(d):Promise.resolve(d).then(a,i)}function _asyncToGenerator(c){return function(){var e=this,o=arguments;return new Promise(function(t,n){var a=c.apply(e,o);function i(e){asyncGeneratorStep(a,t,n,i,r,"next",e)}function r(e){asyncGeneratorStep(a,t,n,i,r,"throw",e)}i(void 0)})}}geotab.addin.proximity=function(){var w,a,x,c,M,d,E,u,s,l,m,f,y,g,p,h,t,T=250,k={},I=[],v=!0,D=!1,S=!1,C=function(e){p.innerHTML=e},G=function(e){clearTimeout(t),e?(h.style.display="block",g.textContent="Cancel",g.style.display="block",g.disabled=!1,d.disable(),E.disabled=!0,u.disabled=!0,s.disabled=!0,l.disabled=!0,f.disabled=!0,y.disabled=!0):t=setTimeout(function(){h.style.display="none",g.style.display="none",d.enable(),E.disabled=!1,u.disabled=!1,s.disabled=!1,l.disabled=!1,f.disabled=!1,y.disabled=!1},600)},b=function(e){return e*(v?1:1.09361)},B=function(e){var t,n=new L.LatLng(e.latitude,e.longitude),a=e.distance,i=(t=n,new L.Marker(t,{icon:new L.DivIcon({className:"map-icon",iconSize:[16,16]})})),r=new Date(e.dateTime);i.bindTooltip("".concat(k[e.device.id].name," was ").concat(Math.floor(b(a))," ").concat(v?" m":" yd"," away on ").concat(r.toDateString()," at ").concat(r.toTimeString())),c.addLayer(i)},z=function(){if(S=!1,C(""),""!==E.value)if(D||0!==I.length){var e=new Date(f.value+":00Z"),v=new Date(e.setMinutes(e.getMinutes()+(new Date).getTimezoneOffset())).toISOString(),t=new Date(y.value+":00Z"),b=new Date(t.setMinutes(t.getMinutes()+(new Date).getTimezoneOffset())).toISOString();c.clearLayers(),M.clearLayers(),G(!0),w.call("GetCoordinates",{addresses:[E.value]},function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var i,r,n,a,o,c,d,u,s,l,m,f,y,g,p,h;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t||t.length<1||!t[0])return C("Could not find the address"),G(!1),e.abrupt("return");e.next=4;break;case 4:if(S)return G(!1),e.abrupt("return");e.next=7;break;case 7:i=function(e){return e.forEach(B),e.length},r=function(e,t,n){return["Get",{typeName:"LogRecord",search:{deviceSearch:{id:e},fromDate:t,toDate:n},resultsLimit:5e4}]},a=(n=function(e,t,n,a,i){return new L.Circle([t,e],n,{stroke:!1,fillColor:a,fillOpacity:i})})(t[0].x,t[0].y,1*T,"#ff4444",.3),o=n(t[0].x,t[0].y,2*T,"#ff8800",.3),c=n(t[0].x,t[0].y,3*T,"#ff8800",.3),d=n(t[0].x,t[0].y,4*T,"#99cc00",.3),u=n(t[0].x,t[0].y,5*T,"#33b5e5",.3),s={latitude:t[0].y,longitude:t[0].x},window.geotabHeatMap=window.geotabHeatMap||{},window.geotabHeatMap.center=s,x.setView(new L.LatLng(s.latitude,s.longitude),14),M.addLayer(a),M.addLayer(o),M.addLayer(c),M.addLayer(d),M.addLayer(u),l=D?Object.keys(k).map(function(e){return k[e]}):I.map(function(e){return k[e]}),m=[],f=function(a){return new Promise(function(t,n){var e=r(a.id,v,b);w.call(e[0],e[1],function(e){5e4===e.length&&m.push(N(a.name));var params={array:e,center:s,radiusFactor:T,aggregate:!0,maxThreads:navigator.hardwareConcurrency||1};hamsters.promise(params,function(){var r=params.center,o=5*params.radiusFactor,c=function(e){return e*(Math.PI/180)};params.array.forEach(function(e){var t=c(r.latitude-e.latitude),n=c(r.longitude-e.longitude),a=Math.sin(t/2)*Math.sin(t/2)+Math.cos(c(e.latitude))*Math.cos(c(r.latitude))*Math.sin(n/2)*Math.sin(n/2),i=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));e.distance=6371e3*i,e.distance<o&&rtn.data.push(e)})}).then(function(rtn){return rtn.data[0]}).then(i).then(t)},function(e){C(e),G(!1),n(e)})})},g=y=0;case 25:if(l.length>g)return e.next=28,f(l[g]);e.next=36;break;case 28:if(p=e.sent,y+=p||0,S)return G(!1),e.abrupt("return");e.next=33;break;case 33:g++,e.next=25;break;case 36:h=0===m.length?"":"<p>* ".concat(m.join(",")," was limited to ").concat(5e4," GPS positions, try narrowing date range to see all positions.</p>"),C(0<y?"<p>There were ".concat(y," locations recorded nearby to ").concat(E.value,".</p>").concat(h):"<p>There was no one near this area during this time frame.</p>".concat(h)),G(!1);case 39:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),function(e){C(e),G(!1)})}else C("Select at least one vehicle to display")},i=function(i,e){var t=function(e){var t,n,a=b(5*e);T=e,n=i&&1e3<=a?(t=Number(Math.round(a/1e3+"e1")+"e-1"),"km"):!i&&1760<=a?(t=Number(Math.round(a/1760+"e1")+"e-1"),"mi"):(t=Math.round(a),i?" m":" yd"),document.getElementById("proximity-size-label").innerHTML="("+t+" "+n+")"};v=i,x=new L.Map("proximity-map",{center:new L.LatLng(e.latitude,e.longitude),zoom:9}),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2VvdGFiIiwiYSI6ImNpd2NlaW02MjAxc28yeW9idTR3dmRxdTMifQ.ZH0koA2g2YMMBOcx6EYbwQ").addTo(x),c=L.markerClusterGroup({spiderfyOnMaxZoom:!1,disableClusteringAtZoom:18}).addTo(x),M=L.layerGroup().addTo(x),E=document.getElementById("proximity-address"),u=document.getElementById("proximity-size"),s=document.getElementById("proximity-select-all"),l=document.getElementById("proximity-vehicles"),f=document.getElementById("proximity-from"),y=document.getElementById("proximity-to"),p=document.getElementById("proximity-error"),h=document.getElementById("proximity-loading"),m=document.getElementById("proximity-div-vehicles"),g=document.getElementById("proximity-cancel");var n=new Date,a=n.getDate(),r=n.getMonth()+1,o=n.getFullYear();a<10&&(a="0"+a),r<10&&(r="0"+r),f.value=o+"-"+r+"-"+a+"T00:00",y.value=o+"-"+r+"-"+a+"T23:59",t(300),(d=new Choices(l,{removeItemButton:!0})).passedElement.element.addEventListener("change",function(){I=d.getValue().map(function(e){return e.value}),z()}),E.addEventListener("keydown",function(e){13===e.keyCode&&z()}),u.addEventListener("change",function(e){t(e.target.value),z()}),s.addEventListener("change",function(e){e.preventDefault(),D=!D,m.style.display=D?"none":"block",z()}),f.addEventListener("change",function(e){e.preventDefault(),z()}),y.addEventListener("change",function(e){e.preventDefault(),z()}),g.addEventListener("click",function(e){e.preventDefault(),g.textContent="Canceling...",g.disabled=!0,S=!0})},N=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")};return{initialize:function(e,t,n){w=e,a=t,hamsters.init&&hamsters.init({debug:"verbose"}),function(t){if(!t)throw new Error('"callback" is null or undefined');w.getSession(function(e){w.call("Get",{typeName:"User",search:{name:e.userName}},function(e){t(0<e.length&&!!e[0].isMetric)},function(){t(!1)})},!1)}(function(t){"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){i(t,e.coords),n()}):(i(t,{longitude:-79.709441,latitude:43.434497}),n())})},focus:function(e,t){w=e,a=t,k={},G(S=!0),w.call("Get",{typeName:"Device",resultsLimit:1e3,search:{fromDate:(new Date).toISOString(),groups:a.getGroupFilter()}},function(e){if(e&&!(e.length<1)){var t=e.map(function(e){return{value:(k[e.id]=e).id,label:N(e.name)}});d=d.setChoices(t,"value","label",!0),G(!1)}},function(e){C(e),G(!1)}),setTimeout(function(){x.invalidateSize()},800)},blur:function(){k&&(k={}),S=!0}}};