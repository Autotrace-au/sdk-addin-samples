"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],a=!0,r=!1,i=void 0;try{for(var o,c=e[Symbol.iterator]();!(a=(o=c.next()).done)&&(n.push(o.value),!t||n.length!==t);a=!0);}catch(e){r=!0,i=e}finally{try{a||null==c.return||c.return()}finally{if(r)throw i}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,a,r,i,o){try{var c=e[i](o),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(a,r)}function _asyncToGenerator(c){return function(){var e=this,o=arguments;return new Promise(function(t,n){var a=c.apply(e,o);function r(e){asyncGeneratorStep(a,t,n,r,i,"next",e)}function i(e){asyncGeneratorStep(a,t,n,r,i,"throw",e)}r(void 0)})}}geotab.addin.proximity=function(){var w,n,x,c,T,u,M,l,d,s,m,f,y,p,g,v,I,t,k=250,S={},D=[],h=!0,E=!1,A=!1,O=["DeviceID, Date, Time, Latitude, Longitude\n"],C=function(e){g.innerHTML=e},_=function(e){clearTimeout(t),e?(I.disabled=!0,v.style.display="block",p.textContent="Cancel",p.style.display="block",p.disabled=!1,u.disable(),M.disabled=!0,l.disabled=!0,d.disabled=!0,s.disabled=!0,f.disabled=!0,y.disabled=!0):t=setTimeout(function(){v.style.display="none",p.style.display="none",u.enable(),M.disabled=!1,l.disabled=!1,d.disabled=!1,s.disabled=!1,f.disabled=!1,y.disabled=!1},600)},b=function(e){return e*(h?1:1.09361)},B=function(e){var t,n=new L.LatLng(e.latitude,e.longitude),a=e.distance,r=(t=n,new L.Marker(t,{icon:new L.DivIcon({className:"map-icon",iconSize:[16,16]})})),i=new Date(e.dateTime);r.bindTooltip("".concat(S[e.device.id].name," was ").concat(Math.floor(b(a))," ").concat(h?" m":" yd"," away on ").concat(i.toDateString()," at ").concat(i.toTimeString())),c.addLayer(r)},G=function(e){var t=e.split("T");return[t[0],t[1].split(".")[0]]},R=function(){if(A=!1,C(""),O=["DeviceID, Date, Time, Latitude, Longitude\n"],""!==M.value)if(E||0!==D.length){var e=new Date(f.value+":00Z"),h=new Date(e.setMinutes(e.getMinutes()+(new Date).getTimezoneOffset())).toISOString(),t=new Date(y.value+":00Z"),b=new Date(t.setMinutes(t.getMinutes()+(new Date).getTimezoneOffset())).toISOString();c.clearLayers(),T.clearLayers(),_(!0);var n,a,r=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,i,n,a,o,c,u,l,d,s,m,f,y,p,g,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t||t.length<1||!t[0])return C("Could not find the address"),_(!1),e.abrupt("return");e.next=4;break;case 4:if(A)return _(!1),e.abrupt("return");e.next=7;break;case 7:r=function(e){return e.forEach(function(e){B(e);var t=_slicedToArray(G(e.dateTime),2),n=t[0],a=t[1];O.push("".concat(S[e.device.id].name,", ").concat(n,", ").concat(a,", ").concat(e.latitude,", ").concat(e.longitude,"\n"))}),e.length},i=function(e,t,n){return["Get",{typeName:"LogRecord",search:{deviceSearch:{id:e},fromDate:t,toDate:n},resultsLimit:5e4}]},a=(n=function(e,t,n,a,r){return new L.Circle([t,e],n,{stroke:!1,fillColor:a,fillOpacity:r})})(t[0].x,t[0].y,1*k,"#ff4444",.3),o=n(t[0].x,t[0].y,2*k,"#ff8800",.3),c=n(t[0].x,t[0].y,3*k,"#ff8800",.3),u=n(t[0].x,t[0].y,4*k,"#99cc00",.3),l=n(t[0].x,t[0].y,5*k,"#33b5e5",.3),d={latitude:t[0].y,longitude:t[0].x},window.geotabHeatMap=window.geotabHeatMap||{},window.geotabHeatMap.center=d,x.setView(new L.LatLng(d.latitude,d.longitude),14),T.addLayer(a),T.addLayer(o),T.addLayer(c),T.addLayer(u),T.addLayer(l),s=E?Object.keys(S).map(function(e){return S[e]}):D.map(function(e){return S[e]}),m=[],f=function(a){return new Promise(function(t,n){var e=i(a.id,h,b);w.call(e[0],e[1],function(e){5e4===e.length&&m.push(j(a.name));var params={array:e,center:d,radiusFactor:k,aggregate:!0,maxThreads:navigator.hardwareConcurrency||1};hamsters.promise(params,function(){var i=params.center,o=5*params.radiusFactor,c=function(e){return e*(Math.PI/180)};params.array.forEach(function(e){if(e.id){var t=c(i.latitude-e.latitude),n=c(i.longitude-e.longitude),a=Math.sin(t/2)*Math.sin(t/2)+Math.cos(c(e.latitude))*Math.cos(c(i.latitude))*Math.sin(n/2)*Math.sin(n/2),r=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));e.distance=6371e3*r,e.distance<o&&rtn.data.push(e)}})}).then(function(rtn){return rtn.data[0]}).then(r).then(t)},function(e){C(e),_(!1),n(e)})})},p=y=0;case 25:if(s.length>p)return e.next=28,f(s[p]);e.next=36;break;case 28:if(g=e.sent,y+=g||0,A)return _(!1),e.abrupt("return");e.next=33;break;case 33:p++,e.next=25;break;case 36:v=0===m.length?"":"<p>* ".concat(m.join(",")," was limited to ").concat(5e4," GPS positions, try narrowing date range to see all positions.</p>"),C(0<y?"<p>There were ".concat(y," locations recorded nearby to ").concat(M.value,".</p>").concat(v):"<p>There was no one near this area during this time frame.</p>".concat(v)),I.disabled=!1,_(!1);case 40:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),i=(n=M.value,2===(a=n.split(",")).length&&parseFloat(a[0])&&parseFloat(a[1])?[{x:parseFloat(a[1]),y:parseFloat(a[0])}]:[]);i.length?r(i):w.call("GetCoordinates",{addresses:[M.value]},function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r(t);case 1:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),function(e){C(e),_(!1)})}else C("Select at least one vehicle to display")},r=function(r,e){var t=function(e){var t,n,a=b(5*e);k=e,n=r&&1e3<=a?(t=Number(Math.round(a/1e3+"e1")+"e-1"),"km"):!r&&1760<=a?(t=Number(Math.round(a/1760+"e1")+"e-1"),"mi"):(t=Math.round(a),r?" m":" yd"),document.getElementById("proximity-size-label").innerHTML="("+t+" "+n+")"};h=r,x=new L.Map("proximity-map",{center:new L.LatLng(e.latitude,e.longitude),zoom:9}),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2VvdGFiIiwiYSI6ImNpd2NlaW02MjAxc28yeW9idTR3dmRxdTMifQ.ZH0koA2g2YMMBOcx6EYbwQ").addTo(x),c=L.markerClusterGroup({spiderfyOnMaxZoom:!1,disableClusteringAtZoom:18}).addTo(x),T=L.layerGroup().addTo(x),M=document.getElementById("proximity-address"),l=document.getElementById("proximity-size"),d=document.getElementById("proximity-select-all"),s=document.getElementById("proximity-vehicles"),f=document.getElementById("proximity-from"),y=document.getElementById("proximity-to"),g=document.getElementById("proximity-error"),v=document.getElementById("proximity-loading"),m=document.getElementById("proximity-div-vehicles"),p=document.getElementById("proximity-cancel"),I=document.getElementById("proximity-run-report");var n=new Date,a=n.getDate(),i=n.getMonth()+1,o=n.getFullYear();a<10&&(a="0"+a),i<10&&(i="0"+i),f.value=o+"-"+i+"-"+a+"T00:00",y.value=o+"-"+i+"-"+a+"T23:59",t(300),(u=new Choices(s,{removeItemButton:!0})).passedElement.element.addEventListener("change",function(){D=u.getValue().map(function(e){return e.value}),R()}),I.addEventListener("click",function(){var e=_slicedToArray(G((new Date).toISOString()),2),t=e[0],n=e[1];!function(e,t){if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t);else{var n=document.createElement("a"),a=URL.createObjectURL(e);n.href=a,n.download=t,document.body.appendChild(n),n.click(),setTimeout(function(){document.body.removeChild(n),window.URL.revokeObjectURL(a)},0)}}(O=O.size?O:new Blob(O),"ProximityReport-".concat(t,"-").concat(n.replace(/\:/g,"."),".csv"))}),M.addEventListener("keydown",function(e){13===e.keyCode&&R()}),l.addEventListener("change",function(e){t(e.target.value),R()}),d.addEventListener("change",function(e){e.preventDefault(),E=!E,m.style.display=E?"none":"block",R()}),f.addEventListener("change",function(e){e.preventDefault(),R()}),y.addEventListener("change",function(e){e.preventDefault(),R()}),p.addEventListener("click",function(e){e.preventDefault(),p.textContent="Canceling...",p.disabled=!0,A=!0})},j=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")};return{initialize:function(e,t,a){w=e,n=t,hamsters.init&&hamsters.init({debug:"verbose"}),function(t){if(!t)throw new Error('"callback" is null or undefined');w.getSession(function(e){w.call("Get",{typeName:"User",search:{name:e.userName}},function(e){t(0<e.length&&!!e[0].isMetric)},function(){t(!1)})},!1)}(function(t){var n={longitude:-79.709441,latitude:43.434497};"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){r(t,e.coords),a()},function(e){r(t,n),a()},{timeout:5e3}):(r(t,n),a())})},focus:function(e,t){w=e,n=t,S={},_(A=!0),w.call("Get",{typeName:"Device",resultsLimit:1e3,search:{fromDate:(new Date).toISOString(),groups:n.getGroupFilter()}},function(e){if(e&&!(e.length<1)){var t=e.map(function(e){return{value:(S[e.id]=e).id,label:j(e.name)}});u=u.setChoices(t,"value","label",!0),_(!1)}},function(e){C(e),_(!1)}),setTimeout(function(){x.invalidateSize()},800)},blur:function(){S&&(S={}),A=!0}}};