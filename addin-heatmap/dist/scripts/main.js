"use strict";geotab.addin.heatmap=function(){function v(e){l.innerHTML=e}function m(e){c.innerHTML=e}var h,p,y,E,I,w,D,i,l,c,d,x,t,B=5e4;function b(e){if(!e||0===e.length)return!0;for(var t=0;t<e.length;t++){if(0<e[t].length)return!1}return!0}function S(e){return e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}function N(){return Math.round((new Date-t)/1e3)}function T(e){e?(i.disabled=!0,d.style.display="block"):(setTimeout(function(){d.style.display="none"},600),i.disabled=!1)}function r(){void 0!==y&&p.removeLayer(y),y=L.heatLayer({radius:{value:24,absolute:!1},opacity:.7,gradient:{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}}).addTo(p);for(var e=x=0;e<I.options.length;e++)I.options[e].selected&&x++;0!==x?(t=new Date,!0===E.disabled?a():u()):v("Please select at least one vehicle from the list and try again.")}function o(e){p=new L.Map("heatmap-map",{center:new L.LatLng(e.latitude,e.longitude),zoom:13}),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2VvdGFiIiwiYSI6ImNpd2NlaW02MjAxc28yeW9idTR3dmRxdTMifQ.ZH0koA2g2YMMBOcx6EYbwQ").addTo(p),E=document.getElementById("exceptionTypes"),I=document.getElementById("vehicles"),w=document.getElementById("from"),D=document.getElementById("to"),i=document.getElementById("showHeatMap"),l=document.getElementById("error"),c=document.getElementById("message"),d=document.getElementById("loading");var t=new Date,n=t.getDate(),o=t.getMonth()+1,a=t.getFullYear();n<10&&(n="0"+n),o<10&&(o="0"+o),w.value=a+"-"+o+"-"+n+"T00:00",D.value=a+"-"+o+"-"+n+"T23:59",document.getElementById("visualizeByLocationHistory").addEventListener("click",function(e){E.disabled=!0}),document.getElementById("visualizeByExceptionHistory").addEventListener("click",function(e){E.disabled=!1}),document.getElementById("exceptionTypes").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("vehicles").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("from").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("to").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("showHeatMap").addEventListener("click",function(e){e.preventDefault(),r()})}function n(e,t){return(e=e.name.toLowerCase())===(t=t.name.toLowerCase())?0:t<e?1:-1}var a=function(){I.value;for(var e,t=[],n=I.options,o=0,a=n.length;o<a;o++)(e=n[o]).selected&&t.push(e.value||e.text);var i=w.value,l=D.value;if(v(""),m(""),null!==t&&""!==i&&""!==l){T(!0);for(var c=new Date(i).toISOString(),d=new Date(l).toISOString(),r=[],u=0,s=t.length;u<s;u++)r.push(["Get",{typeName:"LogRecord",resultsLimit:B,search:{deviceSearch:{id:t[u]},fromDate:c,toDate:d}}]);h.multiCall(r,function(e){if(b(e))return v("No data to display"),void T(!1);for(var t=[],n=[],o=0,a=0,i=[],l=0,c=e.length;l<c;l++){i=e[l];for(var d=0;d<i.length;d++)0===i[d].latitude&&0===i[d].longitude||(t.push({lat:i[d].latitude,lon:i[d].longitude,value:1}),n.push(new L.LatLng(i[d].latitude,i[d].longitude)),o++);i.length>=B&&a++}0<t.length?(p.fitBounds(n),y.setLatLngs(t),m("Displaying ".concat(S(o)," combined log records for the\n        ").concat(S(x)," selected vehicles. [").concat(N()," sec]")),0<a&&v("Note: Not all results are displayed because the result limit of \n          ".concat(S(B)," was exceeded for \n          ").concat(S(a)," of the selected vehicles."))):v("No data to display"),T(!1)},function(e){alert(e),T(!1)})}},u=function(){I.value;for(var e,t=E.options[E.selectedIndex].value,g=E.options[E.selectedIndex].text,n=[],o=I.options,a=0,i=o.length;a<i;a++)(e=o[a]).selected&&n.push(e.value||e.text);var l=w.value,c=D.value;if(v(""),m(""),null!==n&&null!==t&&""!==l&&""!==c){T(!0);for(var d=new Date(l).toISOString(),r=new Date(c).toISOString(),u=[],s=0,f=n.length;s<f;s++)u.push(["Get",{typeName:"ExceptionEvent",resultsLimit:B,search:{deviceSearch:{id:n[s]},ruleSearch:{id:t},fromDate:d,toDate:r}}]);h.multiCall(u,function(e){if(b(e))return v("No data to display"),void T(!1);for(var u=0,s=0,t=[],n=0,o=e.length;n<o;n++){for(var a=e[n],i=0;i<a.length;i++)u++,t.push(["Get",{typeName:"LogRecord",resultsLimit:B,search:{deviceSearch:{id:a[i].device.id},fromDate:a[i].activeFrom,toDate:a[i].activeTo}}]);a.length>=B&&s++}h.multiCall(t,function(e){if(b(e))return v("No data to display"),void T(!1);for(var t=[],n=[],o=0,a=0,i=0,l=e.length;i<l;i++){for(var c=e[i],d=0;d<c.length;d++)0===c[d].latitude&&0===c[d].longitude||(t.push({lat:c[d].latitude,lon:c[d].longitude,value:1}),n.push(new L.LatLng(c[d].latitude,c[d].longitude)),o++);c.length>=B&&a++}if(0<t.length){if(p.fitBounds(n),y.setLatLngs(t),m("Displaying ".concat(S(o)," combined log records associated with the\n          ").concat(S(u)," '").concat(g,"' rule exceptions found for the \n          ").concat(S(x)," selected vehicles. [").concat(N()," sec]")),0<s||0<a){var r="Note: Not all results are displayed because";s&&(r+=" the result limit of \n              ".concat(S(B)," was exceeded for '").concat(g,"' rule exceptions")),0<s&&0<a&&(r+=" and"),0<a&&(r+=" the result limit of \n              ".concat(S(B)," was exceeded for \n              ").concat(S(exceededResultsLimitCount)," of the selected vehicles.")),v(r+=".")}T(!1)}else v("No data to display")},function(e){alert(e),T(!1)})},function(e){alert(e),T(!1)})}};return{initialize:function(e,t,n){h=e,"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){o(e.coords),n()}):(o({longitude:-79.709441,latitude:43.434497}),n())},focus:function(e,t){(h=e).call("Get",{typeName:"Device",resultsLimit:5e4,search:{fromDate:(new Date).toISOString(),groups:t.getGroupFilter()}},function(e){!e||e.length<0||(e.sort(n),e.forEach(function(e){var t=new Option;t.text=e.name,t.value=e.id,I.add(t)}))},v),h.call("Get",{typeName:"Rule",resultsLimit:5e4},function(e){!e||e.length<0||(e.sort(n),e.forEach(function(e){var t=new Option;t.text=e.name,t.value=e.id,E.add(t)}))},v),setTimeout(function(){p.invalidateSize()},200)}}};